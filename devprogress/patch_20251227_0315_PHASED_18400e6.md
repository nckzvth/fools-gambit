# patch_20251227_0315_PHASED_18400e6

Phase:

- PHASED (Majors via data-driven primitives)

Scope summary (what changed):

- Implemented majors content loading and lookup (majors.json + strings) inside game-core.
- Implemented shadow hook dispatcher + primitive interpreter (no per-major bespoke code paths).
- Wired FloorStart/RoomReveal/BeforeFirstResolve/AfterFirstResolution hooks into the engine loop.
- Added a majors prompt system (choice/bargain/reorder/target select) that gates legality until resolved.
- Implemented attunement selection at FloorStart and attuned gift usage in PreResolveWindow.
- Added replay-style tests ensuring each Major is exercised via its data definition and replays deterministically.

Files changed:

- packages/game-core/src/index.ts
- packages/game-core/src/content.ts
- packages/game-core/src/majors.ts
- packages/game-core/src/engine.ts
- packages/game-core/src/rules.ts
- packages/game-core/src/types.ts
- packages/game-core/src/engine.test.ts
- packages/game-core/src/engine.boss.test.ts
- packages/game-core/src/engine.majors.replay.test.ts
- packages/game-data/schemas/run_state.schema.json
- devprogress/patch_20251227_0315_PHASED_18400e6.md

Behavior changes (must map to spec sections):

- Majors are now driven by data primitives from majors.json only (spec §0.3, §14.2, §18 Phase D).
- FloorStart now requires attunement selection and runs FLOOR_START + ORDER_CONSTRAINT hooks before the first RoomReveal (spec §2.1).
- Hooks fire at the locked timing windows and restrict legality when Major prompts are pending (spec §2.1–§2.2).
- BEFORE_FIRST_RESOLVE_ATTEMPT (Hanged Man) is enforced deterministically on first resolve attempt of the room (spec §14.2).

New/updated tests:

- packages/game-core/src/engine.majors.replay.test.ts (one replay per major + determinism)
- packages/game-core/src/engine.test.ts (loads content; stabilizes floor major for unit tests)
- packages/game-core/src/engine.boss.test.ts (loads content)

Replays added/updated:

- Replay-style coverage generated in test (one per major).

Content/schema changes:

- packages/game-data/schemas/run_state.schema.json updated to include:
  - room.carryChoiceIndex (Order shadow “choose carried first”)
  - floor.params.chariotDirection (SET_FLOOR_PARAM for Chariot)

Migration notes:

- saveVersion bump? no
- migration implemented? no

Known issues / follow-ups:

- Phase E: implement Pixi UI for the Major prompt windows (choice/bargain/reorder/peek) and attunement selection driven by engine legality.

Next phase entry criteria checklist:

- [x] No per-major bespoke code paths (only primitives + interpreter)
- [x] At least one replay test per major
- [x] CI stays green (validate + typecheck + lint + test)
