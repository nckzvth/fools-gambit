# patch_20251227_0240_PHASEB_43cd1fd

Phase:

- PHASEB (Engine core loop)

Scope summary (what changed):

- Implemented core room loop state machine (RoomReveal → RoomChoice → PreResolveWindow → ResolveExecute → RoomEnd).
- Implemented Minor deck setup (seeded shuffle + random reversals) and deterministic resolution for suits/combat/Fate/Leap/spells/weapons.
- Added unit tests to cover major rule branches and determinism.

Files changed:

- packages/game-core/src/index.ts
- packages/game-core/src/**/*
- devprogress/patch_20251227_0240_PHASEB_43cd1fd.md

Behavior changes (must map to spec sections):

- Engine exposes UI-agnostic `createRun`, `getLegalActions`, `applyAction` entrypoints (spec §0.1, §9).
- Engine determinism enforced via seeded xorshift32 RNG usage for all random operations (spec §0.2, §10).
- Room timing windows modeled as explicit phases and legality gating (spec §2.1, §2.2).
- Effective orientation + Fate gain rules implemented (spec §3.1–§3.3).
- Healing limiter enforced per-room for all healing sources (spec §3.7).

New/updated tests:

- packages/game-core/src/**/*.test.ts

Replays added/updated:

- None (Phase C+).

Content/schema changes:

- None.

Migration notes:

- saveVersion bump? no
- migration implemented? no

Known issues / follow-ups:

- Phase C will wire floors/boss + boss corruption + boss deck composition using `floor.floorDiscard` and `floor.bossDeck` (spec §3.4, §4, §10).

Next phase entry criteria checklist:

- [x] Headless simulation can complete rooms reliably
- [x] Tests cover suit logic and combat
- [x] CI stays green (validate + typecheck + lint + test)
