# patch_20251227_0400_PHASEF_18400e6

Phase:

- PHASEF (Hardening + parity corpus)

Scope summary (what changed):

- Implemented stable state hashing (canonical JSON + SHA-256 hex) for parity and replay checkpoints.
- Added replay runner utilities and a committed replay corpus (120 runs) under `/replays`.
- Added CI-running invariants + fuzz/property tests and corpus checkpoint verification.

Files changed:

- packages/game-core/src/stateHash.ts
- packages/game-core/src/replay.ts
- packages/game-core/src/replays.corpus.test.ts
- packages/game-core/src/invariants.fuzz.test.ts
- packages/game-core/src/engine.ts
- packages/game-core/src/index.ts
- packages/game-core/tsconfig.json
- packages/game-core/scripts/generate-replay-corpus.mjs
- packages/game-core/package.json
- package.json
- replays/corpus_v1.json
- devprogress/patch_20251227_0400_PHASEF_18400e6.md

Behavior changes (must map to spec sections):

- Added deterministic state hashing with stable key ordering and SHA-256 hex output; `debug` is excluded from the hash (spec §13.2–§13.4).
- Ensured HP reaching 0 transitions the run to `RunDefeat` immediately (prevents dead states with no legal actions).

New/updated tests:

- packages/game-core/src/invariants.fuzz.test.ts
- packages/game-core/src/replays.corpus.test.ts

Replays added/updated:

- replays/corpus_v1.json (120 runs, action logs + state hash checkpoints)

Content/schema changes:

- None

Migration notes:

- saveVersion bump? no
- migration implemented? no

Known issues / follow-ups:

- Phase G: Unity parity runner can consume `/replays/corpus_v1.json` and compare state hashes at checkpoints.

Next phase entry criteria checklist:

- [x] invariants and fuzz/property tests (time budgeted)
- [x] replay corpus (100+ runs) under /replays
- [x] stable state hashing
- [x] CI includes fuzz/invariants
- [x] replay corpus stable
